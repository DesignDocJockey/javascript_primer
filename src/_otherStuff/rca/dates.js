'use strict';

const Moment = require('moment');
const _ = require('lodash');

const givenAFirstQuarterFormat = `Q1 '01'`;
const givenASecondQuarterFormat = `Q2 '01'`;
const givenAThirdQuarterFormat = `Q3 '01'`;
const givenAFourthQuarterFormat = `Q4 '01'`;

const esResponsePropTypes = { 
    "Office - Sub": {
     "quarters": {
      "Q1 '08": {
       "vol": 31940886648.571095,
       "prop": 2244,
       "unit": 129475304.20261344
      },
      "Q2 '08": {
       "vol": 24962048371.034103,
       "prop": 1230,
       "unit": 97445528.23890999
      },
      "Q3 '08": {
       "vol": 21728756978.649902,
       "prop": 1010,
       "unit": 87541054.63066296
      },
      "Q4 '08": {
       "vol": 15071659903.570396,
       "prop": 865,
       "unit": 64427025.62554808
      },
      "Q1 '09": {
       "vol": 7895980985.659199,
       "prop": 504,
       "unit": 33670494.4320513
      },
      "Q2 '09": {
       "vol": 8779503862.927898,
       "prop": 573,
       "unit": 46381585.1753061
      },
      "Q3 '09": {
       "vol": 12179730650.0873,
       "prop": 608,
       "unit": 69294142.35121423
      },
      "Q4 '09": {
       "vol": 17968385331.1494,
       "prop": 767,
       "unit": 77182146.85191998
      },
      "Q1 '10": {
       "vol": 13760640767.9842,
       "prop": 676,
       "unit": 70415840.47303998
      },
      "Q2 '10": {
       "vol": 13603721575.139101,
       "prop": 707,
       "unit": 70798935.60023999
      },
      "Q3 '10": {
       "vol": 15110716846.414497,
       "prop": 758,
       "unit": 75924617.86072001
      },
      "Q4 '10": {
       "vol": 25857787576.770397,
       "prop": 1132,
       "unit": 124238350.26588939
      },
      "Q1 '11": {
       "vol": 18611371772.802303,
       "prop": 916,
       "unit": 91267342.53044
      },
      "Q2 '11": {
       "vol": 22533339174.434704,
       "prop": 968,
       "unit": 103757843.95726675
      },
      "Q3 '11": {
       "vol": 21249709420.5266,
       "prop": 1165,
       "unit": 96886649.7340962
      },
      "Q4 '11": {
       "vol": 30100638968.29319,
       "prop": 1546,
       "unit": 141675176.59636
      },
      "Q1 '12": {
       "vol": 19570793219.685,
       "prop": 975,
       "unit": 103660781.86368003
      },
      "Q2 '12": {
       "vol": 19487129911.949997,
       "prop": 1323,
       "unit": 104560676.55355386
      },
      "Q3 '12": {
       "vol": 23301768488.40989,
       "prop": 1181,
       "unit": 115129825.72078872
      },
      "Q4 '12": {
       "vol": 31666333596.8068,
       "prop": 2331,
       "unit": 172339174.48271972
      },
      "Q1 '13": {
       "vol": 22076630650.588905,
       "prop": 1064,
       "unit": 107692645.83004759
      },
      "Q2 '13": {
       "vol": 23134168192.553898,
       "prop": 1359,
       "unit": 115533416.79200369
      },
      "Q3 '13": {
       "vol": 30278423297.260212,
       "prop": 1399,
       "unit": 132318641.74942519
      },
      "Q4 '13": {
       "vol": 39679942862.23447,
       "prop": 2164,
       "unit": 197664205.6800345
      },
      "Q1 '14": {
       "vol": 29540106480.5631,
       "prop": 1398,
       "unit": 153391327.40263996
      },
      "Q2 '14": {
       "vol": 32482203069.21401,
       "prop": 1520,
       "unit": 143211221.38915998
      },
      "Q3 '14": {
       "vol": 34722697200.71381,
       "prop": 1797,
       "unit": 170210477.75008
      },
      "Q4 '14": {
       "vol": 48712098610.50502,
       "prop": 2369,
       "unit": 231634355.9644571
      },
      "Q1 '15": {
       "vol": 39694099137.28789,
       "prop": 1802,
       "unit": 169435828.9953836
      },
      "Q2 '15": {
       "vol": 40524093486.3295,
       "prop": 1922,
       "unit": 183640703.88574976
      },
      "Q3 '15": {
       "vol": 42908501920.6764,
       "prop": 2365,
       "unit": 225495677.90171975
      },
      "Q4 '15": {
       "vol": 51979257706.6606,
       "prop": 2367,
       "unit": 247526417.83344007
      },
      "Q1 '16": {
       "vol": 35336227673.486,
       "prop": 1884,
       "unit": 166200535.66380358
      },
      "Q2 '16": {
       "vol": 37416677069.7584,
       "prop": 1886,
       "unit": 160625879.21410185
      },
      "Q3 '16": {
       "vol": 37673456650.9246,
       "prop": 1784,
       "unit": 182052202.13146558
      },
      "Q4 '16": {
       "vol": 57784137363.864395,
       "prop": 2714,
       "unit": 244528168.99403745
      },
      "Q1 '17": {
       "vol": 37399004466.714195,
       "prop": 2134,
       "unit": 175398503.200224
      },
      "Q2 '17": {
       "vol": 43486954209.714325,
       "prop": 2151,
       "unit": 202659850.50180528
      },
      "Q3 '17": {
       "vol": 49420459768.920715,
       "prop": 2198,
       "unit": 209951500.1168282
      },
      "Q4 '17": {
       "vol": 55801950659.9613,
       "prop": 2449,
       "unit": 215009508.6222484
      },
      "Q1 '18": {
       "vol": 35763603968.4772,
       "prop": 1746,
       "unit": 150400422.40946054
      },
      "Q2 '18": {
       "vol": 50871500782.76321,
       "prop": 1977,
       "unit": 172833564.4560653
      },
      "Q3 '18": {
       "vol": 14545934824.375002,
       "prop": 598,
       "unit": 59721374.91293818
      }
     },
     "years": {
      "2008": {
       "vol": 93703351901.8255,
       "prop": 5349,
       "unit": 378888912.69773436
      },
      "2009": {
       "vol": 46823600829.82378,
       "prop": 2452,
       "unit": 226528368.81049162
      },
      "2010": {
       "vol": 68332866766.3082,
       "prop": 3273,
       "unit": 341377744.19988954
      },
      "2011": {
       "vol": 92495059336.05687,
       "prop": 4595,
       "unit": 433587012.81816304
      },
      "2012": {
       "vol": 94026025216.85162,
       "prop": 5810,
       "unit": 495690458.62074256
      },
      "2013": {
       "vol": 115169165002.63751,
       "prop": 5986,
       "unit": 553208910.0515109
      },
      "2014": {
       "vol": 145457105360.99594,
       "prop": 7084,
       "unit": 698447382.5063373
      },
      "2015": {
       "vol": 175105952250.9544,
       "prop": 8456,
       "unit": 826098628.6162931
      },
      "2016": {
       "vol": 168210498758.03345,
       "prop": 8268,
       "unit": 753406786.0034082
      },
      "2017": {
       "vol": 186108369105.31055,
       "prop": 8932,
       "unit": 803019362.4411058
      },
      "2018": {
       "vol": 101181039575.61542,
       "prop": 4321,
       "unit": 382955361.7784642
      }
     }
    },
    "Office - CBD": {
     "quarters": {
      "Q1 '08": {
       "vol": 28002815664.277306,
       "prop": 593,
       "unit": 68353668.25124457
      },
      "Q2 '08": {
       "vol": 24999674556.8838,
       "prop": 444,
       "unit": 56270352.84484404
      },
      "Q3 '08": {
       "vol": 27224247683.242096,
       "prop": 471,
       "unit": 63530150.284192264
      },
      "Q4 '08": {
       "vol": 16188329560.755598,
       "prop": 347,
       "unit": 42990737.79792534
      },
      "Q1 '09": {
       "vol": 9152166944.4676,
       "prop": 258,
       "unit": 26786108.74068
      },
      "Q2 '09": {
       "vol": 9647188773.808601,
       "prop": 327,
       "unit": 22198314.27189456
      },
      "Q3 '09": {
       "vol": 14618533875.377104,
       "prop": 337,
       "unit": 41900472.57395999
      },
      "Q4 '09": {
       "vol": 20850964123.4114,
       "prop": 424,
       "unit": 55040949.86996575
      },
      "Q1 '10": {
       "vol": 14455122341.075394,
       "prop": 390,
       "unit": 39135864.99304007
      },
      "Q2 '10": {
       "vol": 16802102145.816998,
       "prop": 361,
       "unit": 46939489.72004
      },
      "Q3 '10": {
       "vol": 20531662557.301994,
       "prop": 375,
       "unit": 46980311.78356001
      },
      "Q4 '10": {
       "vol": 34480037769.90109,
       "prop": 544,
       "unit": 84552821.27662358
      },
      "Q1 '11": {
       "vol": 22212186227.883095,
       "prop": 475,
       "unit": 59348023.75727999
      },
      "Q2 '11": {
       "vol": 25662904103.315002,
       "prop": 514,
       "unit": 66516377.18018975
      },
      "Q3 '11": {
       "vol": 29131579724.7603,
       "prop": 647,
       "unit": 79530770.23901021
      },
      "Q4 '11": {
       "vol": 34712807622.95082,
       "prop": 560,
       "unit": 99135843.61771365
      },
      "Q1 '12": {
       "vol": 25928171981.750202,
       "prop": 466,
       "unit": 71920296.47711138
      },
      "Q2 '12": {
       "vol": 28965397144.840504,
       "prop": 571,
       "unit": 73672069.32931054
      },
      "Q3 '12": {
       "vol": 23822146546.5897,
       "prop": 480,
       "unit": 61906704.3243998
      },
      "Q4 '12": {
       "vol": 41193299221.520615,
       "prop": 710,
       "unit": 110828857.41024
      },
      "Q1 '13": {
       "vol": 25858193323.418793,
       "prop": 470,
       "unit": 58648801.60764
      },
      "Q2 '13": {
       "vol": 33225404702.41159,
       "prop": 576,
       "unit": 90241930.0146
      },
      "Q3 '13": {
       "vol": 29703453980.578594,
       "prop": 588,
       "unit": 82199552.03713219
      },
      "Q4 '13": {
       "vol": 52073482429.36588,
       "prop": 803,
       "unit": 123401104.96048
      },
      "Q1 '14": {
       "vol": 31960039664.5506,
       "prop": 572,
       "unit": 87765229.36896884
      },
      "Q2 '14": {
       "vol": 39555272718.56168,
       "prop": 638,
       "unit": 95318324.71992007
      },
      "Q3 '14": {
       "vol": 43313278013.89671,
       "prop": 725,
       "unit": 102759348.86544001
      },
      "Q4 '14": {
       "vol": 50799933306.17999,
       "prop": 843,
       "unit": 122044433.77312994
      },
      "Q1 '15": {
       "vol": 36404695565.4454,
       "prop": 675,
       "unit": 89605505.87208
      },
      "Q2 '15": {
       "vol": 38882321914.1532,
       "prop": 753,
       "unit": 94632260.58501008
      },
      "Q3 '15": {
       "vol": 40770993762.06181,
       "prop": 726,
       "unit": 96327026.12043013
      },
      "Q4 '15": {
       "vol": 54675398989.748116,
       "prop": 885,
       "unit": 127344075.32131997
      },
      "Q1 '16": {
       "vol": 35831437298.95911,
       "prop": 657,
       "unit": 77166418.90032001
      },
      "Q2 '16": {
       "vol": 41448486820.9393,
       "prop": 704,
       "unit": 102404547.17124003
      },
      "Q3 '16": {
       "vol": 35070694607.395195,
       "prop": 619,
       "unit": 91267013.67505735
      },
      "Q4 '16": {
       "vol": 47560092075.07361,
       "prop": 763,
       "unit": 111473847.94447999
      },
      "Q1 '17": {
       "vol": 36276077760.7771,
       "prop": 695,
       "unit": 88480220.41199999
      },
      "Q2 '17": {
       "vol": 38102760914.46991,
       "prop": 662,
       "unit": 81559731.75236502
      },
      "Q3 '17": {
       "vol": 33133833102.860115,
       "prop": 666,
       "unit": 84666095.79652001
      },
      "Q4 '17": {
       "vol": 49031544470.483,
       "prop": 743,
       "unit": 101762472.33405733
      },
      "Q1 '18": {
       "vol": 36551562707.200386,
       "prop": 587,
       "unit": 74127930.64440002
      },
      "Q2 '18": {
       "vol": 47783419913.24519,
       "prop": 635,
       "unit": 86695337.00288315
      },
      "Q3 '18": {
       "vol": 27822224749.40719,
       "prop": 289,
       "unit": 51587663.969
      }
     },
     "years": {
      "2008": {
       "vol": 96415067465.15877,
       "prop": 1855,
       "unit": 231144909.17820626
      },
      "2009": {
       "vol": 54268853717.064705,
       "prop": 1346,
       "unit": 145925845.4565003
      },
      "2010": {
       "vol": 86268924814.0955,
       "prop": 1670,
       "unit": 217608487.77326354
      },
      "2011": {
       "vol": 111719477678.90921,
       "prop": 2196,
       "unit": 304531014.7941936
      },
      "2012": {
       "vol": 119909014894.70093,
       "prop": 2227,
       "unit": 318327927.5410617
      },
      "2013": {
       "vol": 140860534435.77496,
       "prop": 2437,
       "unit": 354491388.6198523
      },
      "2014": {
       "vol": 165628523703.189,
       "prop": 2778,
       "unit": 407887336.72745883
      },
      "2015": {
       "vol": 170733410231.40848,
       "prop": 3039,
       "unit": 407908867.8988402
      },
      "2016": {
       "vol": 159910710802.3672,
       "prop": 2743,
       "unit": 382311827.6910972
      },
      "2017": {
       "vol": 156544216248.58997,
       "prop": 2766,
       "unit": 356468520.29494214
      },
      "2018": {
       "vol": 112157207369.85289,
       "prop": 1511,
       "unit": 212410931.61628312
      }
     }
    }
   }
  ;
const convertQuarterToDate = (quarterFormat) => {
    const year = `20${quarterFormat.trim().slice(4).substring(0, 2)}`;
    const mmDD = Moment(quarterFormat, 'Q').format('MM-DD');
    return Moment(`${year}-${mmDD}`).utc();
};

const firstQtr = convertQuarterToDate(givenAFirstQuarterFormat);
console.log(`converted 1st quarter: ${JSON.stringify(firstQtr, undefined, 1)}`);

const secondQtr = convertQuarterToDate(givenASecondQuarterFormat);
console.log(`converted 2nd quarter: ${JSON.stringify(secondQtr, undefined, 1)}`);

const thirdQtr = convertQuarterToDate(givenAThirdQuarterFormat);
console.log(`converted 3rd quarter: ${JSON.stringify(thirdQtr, undefined, 1)}`);

const fourthQtr = convertQuarterToDate(givenAFourthQuarterFormat);
console.log(`converted 4th quarter: ${JSON.stringify(fourthQtr, undefined, 1)}`);


const someQuarter = `Q4 '08'`;
const qtrsAfter = convertQuarterToDate(someQuarter);
console.log(`Some Quarter: ${JSON.stringify(qtrsAfter, undefined, 1)}`);

const propertyTypeNames = Object.keys(esResponsePropTypes);
const oreduce = (f, acc, o)=> Object.keys(o).reduce((acc, k) => f(acc, o[k], k, o), acc);
const ofilter = (f, o) => oreduce ((acc, v, k, o) => f(v, k, o) ? _.assign(acc, {[k]: v}) : acc, {}, o);

//filter only the necessary years
propertyTypeNames.forEach(propTypeName => {
        let qtrsAllowed = ofilter((v,q) =>   {
            console.log(`v: ${JSON.stringify(v)}`);
            console.log(`q: ${JSON.stringify(q)}`);
            return convertQuarterToDate(q).isAfter(qtrsAfter); 
        } , 
        esResponsePropTypes[propTypeName].quarters);
        console.log(`Quarters allowed... ${JSON.stringify(qtrsAllowed, undefined, 1)}`);
    });
    
